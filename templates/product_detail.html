<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ product.name }} - GSpaces</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet"/>
  <style>
    /* Gallery zoom and thumbnail */
    .gs-main-wrap { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; margin-bottom:16px; position: relative;}
    .gs-main-image { position: relative; width:460px; max-width:100%; height:460px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; cursor: crosshair;}
    .gs-main-image img { width:100%; height:100%; object-fit:contain; transition: transform 0.2s ease;}
    #zoomResult { position:absolute; left:75%; top:0; width:520px; height:460px; border:1px solid #ccc; border-radius:8px; background-repeat:no-repeat; display:none; z-index:10; box-shadow:0 4px 12px rgba(0,0,0,0.15); background-color:#fff;}
    .gs-thumb-row { display:flex; align-items:center; gap:10px; margin-top:10px; }
    .gs-thumb-strip { display:flex; gap:10px; overflow-x:auto; scroll-behavior:smooth; padding-bottom:6px; max-width:100%; }
    .gs-thumb-container { display:inline-block; position:relative; }
    .gs-thumb { width:70px; height:70px; object-fit:cover; border:2px solid transparent; border-radius:6px; cursor:pointer; transition:border-color 0.2s;}
    .gs-thumb:hover, .gs-thumb.active { border-color:#007bff; }
    .thumb-actions { display:none; position:absolute; top:2px; right:2px; gap:4px; }
    .gs-thumb-container:hover .thumb-actions { display:flex !important; }
    .product-info h1 { font-size:2.2rem; font-weight:600; margin-bottom:10px; color:#111;}
    .product-info .category { font-size:1rem; margin-bottom:10px; color:#666;}
    .rating-stars { color:#ffa41c; font-size:1.2rem; }
    .rating-text { font-size:0.95rem; color:#565959; }
    .product-info .price { font-size:1.9rem; font-weight:700; color:#B12704; margin-top:10px; margin-bottom:20px; }
    .product-info .description { font-size:1.05rem; line-height:1.6; color:#333; margin-bottom:30px;}
    .btn-add-cart { background-color:#ffa41c; border-color:#ffa41c; color:#111; font-weight:600;}
    .btn-add-cart:hover { background-color:#f8981d; border-color:#f8981d; color:#111;}
.trust-policies .policy {
  padding: 20px;
  border-radius: 10px;
  background: #fff;
  min-height: 160px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.trust-policies .policy:hover {
  transform: translateY(-6px) scale(1.05);
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

.trust-policies .row > div {
  margin-bottom: 20px; /* space between rows (mobile) */
}


    @media (max-width:992px) { .gs-main-image { height:360px;} #zoomResult { display:none !important;} }
  </style>
</head>
<body>

  {% include 'navbar.html' %}

  <div class="container product-detail-container mt-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="alert-container mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if product %}
    <div class="row">
      <!-- Left Column: Gallery -->
      <div class="col-md-6">
        <div class="gs-main-wrap">
          <div class="gs-main-image" id="mainImageBox">
            <img id="mainImg" src="{{ url_for('static', filename=product['image_url']) }}" alt="{{ product['name'] }}">
          </div>
          <div id="zoomResult"></div>
        </div>

        <div class="gs-thumb-row">
          <button class="gs-thumb-nav" id="thumbPrev">&#10094;</button>
          <div class="gs-thumb-strip" id="thumbStrip">
            <!-- Main image -->
            <div class="gs-thumb-container">
              <img class="gs-thumb active" src="{{ url_for('static', filename=product['image_url']) }}" data-src="{{ url_for('static', filename=product['image_url']) }}" data-index="0" alt="{{ product['name'] }}">
              {% if current_user.is_authenticated and current_user.is_admin %}
              <div class="thumb-actions">
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editMainImageModal">E</button>
                <form action="{{ url_for('delete_main_image', product_id=product['id']) }}" method="post" style="display:inline;">
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete main image?')">D</button>
                </form>
              </div>
              {% endif %}
            </div>
            <!-- Sub-images -->
            {% for sub_image in sub_images %}
            <div class="gs-thumb-container">
              <img class="gs-thumb" src="{{ url_for('static', filename=sub_image['image_url']) }}" data-src="{{ url_for('static', filename=sub_image['image_url']) }}" data-index="{{ loop.index }}" alt="Sub-image {{ loop.index }}">
              {% if current_user.is_authenticated and current_user.is_admin %}
              <div class="thumb-actions">
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editSubImageModal{{ sub_image['id'] }}">E</button>
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteSubImageModal{{ sub_image['id'] }}">D</button>
              </div>
              {% endif %}
            </div>

            <!-- Edit Sub-image Modal -->
            <div class="modal fade" id="editSubImageModal{{ sub_image['id'] }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <form action="{{ url_for('edit_sub_image', sub_image_id=sub_image['id']) }}" method="post" enctype="multipart/form-data" class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">E</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label">Change Image (optional)</label>
                      <input type="file" name="sub_image" class="form-control">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Description</label>
                      <textarea name="sub_description" class="form-control" rows="2" required>{{ sub_image['description'] }}</textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Update</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Delete Sub-image Modal -->
            <div class="modal fade" id="deleteSubImageModal{{ sub_image['id'] }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <form action="{{ url_for('delete_sub_image', sub_image_id=sub_image['id']) }}" method="post" class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Delete Sub-image?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>Are you sure you want to delete this sub-image?</p>
                    <p><strong>{{ sub_image['description'] }}</strong></p>
                    <img src="{{ url_for('static', filename=sub_image['image_url']) }}" style="width:100%; max-height:200px; object-fit:cover; border:1px solid #ddd; border-radius:5px;">
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">D</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  </div>
                </form>
              </div>
            </div>

            {% endfor %}
          </div>
          <button class="gs-thumb-nav" id="thumbNext">&#10095;</button>
        </div>

        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="mt-3">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#subImageModal">+ Add Sub-image</button>
        </div>
        {% endif %}
      </div>

      <!-- Right Column: Info -->
      <div class="col-md-6 product-info">
        <h1>{{ product['name'] }}</h1>
        <p class="category">{{ product['category'] }}</p>
        <div class="rating mb-3">
          {% if product['rating'] %}
            <span class="rating-stars">
              {% for i in range(product['rating']|int) %}<i class="bi bi-star-fill"></i>{% endfor %}
              {% for i in range(5-(product['rating']|int)) %}<i class="bi bi-star"></i>{% endfor %}
            </span>
            <span class="rating-text ms-2">({{ product['rating'] }} out of 5)</span>
          {% else %}
            <span class="rating-text">No rating yet</span>
          {% endif %}
        </div>
        <p class="price">₹{{ product['price']|inr }}</p>
        <p class="description">{{ product['description'] }}</p>
        <form action="{{ url_for('add_to_cart', product_id=product['id']) }}" method="post" class="mt-3">
          <button type="submit" class="btn btn-add-cart btn-lg w-100">Add to Cart</button>
        </form>
        <!-- Promo Banner inside Product Detail -->
        <div class="promo-banner text-center my-4 p-3 rounded" 
            style="background:#1a1a1a; border:1px solid #f5d76e; color:#f5d76e; font-size:16px; font-weight:600;">
          <strong>🔥 Limited Time Offer:</strong> Order in the next 
          <span id="product-countdown" style="color:#ffffff; font-weight:700;">00:00:00</span> 
          and get <strong style="color:#f5d76e;">5% OFF</strong>!
        </div>

        <script>
        function startCountdownFromBackend(elementId, initialRemaining) {
          const el = document.getElementById(elementId);
          if (!el) return;

          let remaining = initialRemaining || 0;

          async function fetchStatus() {
            try {
              const res = await fetch("/countdown_status");
              const data = await res.json();
              if (data.active) remaining = data.remaining;
              else remaining = 0;
            } catch (err) {
              console.error("Failed to fetch countdown:", err);
            }
          }

          function render() {
            if (remaining <= 0) {
              el.textContent = "00:00:00";
              return;
            }
            let hours = Math.floor((remaining / 3600) % 24);
            let minutes = Math.floor((remaining / 60) % 60);
            let seconds = Math.floor(remaining % 60);

            el.textContent =
              (hours < 10 ? "0" + hours : hours) + ":" +
              (minutes < 10 ? "0" + minutes : minutes) + ":" +
              (seconds < 10 ? "0" + seconds : seconds);

            remaining--;
          }

          // keep backend synced every 30s
          setInterval(fetchStatus, 30000);
          setInterval(render, 1000);
          render();
        }

        // Initialize product detail countdown
        startCountdownFromBackend("product-countdown", {{ countdown_data.remaining|default(0) }});
        </script>

        <!-- Stock Info -->
        <div class="stock-info text-center my-4 p-3 rounded" style="background:#e8f7ff; border:1px solid #b6e0fe;">
          <strong>Only <span style="color:#007bff;">5 items</span> left in stock!</strong> Don’t miss out 🚀
        </div>
        <!-- Social Proof -->
        <div class="social-proof text-center my-4 p-3 rounded" style="background:#f8f9fa; border:1px solid #ddd;">
          ⭐️⭐️⭐️⭐️⭐️ <br>
          <small>Trusted by <strong>5000+ Happy Customers</strong> across India</small>
        </div>
        <!-- Freebie -->
        <div class="freebie text-center my-4 p-3 rounded" style="background:#e6ffed; border:1px solid #b3e6cc;">
          🎁 <strong>Special Bonus:</strong> Free installation included with your order!
        </div>

        <!-- Trust Policies -->
        <div class="trust-policies mt-5">
          <div class="row text-center justify-content-between">
            <div class="col-6 col-md-3">
              <div class="policy">
                <i class="bi bi-truck fs-1 text-warning"></i>
                <h6 class="mt-3">Free Delivery</h6>
                <p class="small text-muted">No extra charges on orders.</p>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="policy">
                <i class="bi bi-arrow-repeat fs-1 text-warning"></i>
                <h6 class="mt-3">10 Days Replacement</h6>
                <p class="small text-muted">Easy replacement within 10 days.</p>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="policy">
                <i class="bi bi-shield-lock fs-1 text-warning"></i>
                <h6 class="mt-3">Secure Payment</h6>
                <p class="small text-muted">100% secure via Razorpay.</p>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="policy">
                <i class="bi bi-tools fs-1 text-warning"></i>
                <h6 class="mt-3">Assembly Available</h6>
                <p class="small text-muted">Expert help at your doorstep.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Tabs (Specifications, Warranty, Reviews) -->
    <div class="row mt-5">
      <div class="col-12">
        <ul class="nav nav-tabs" id="productTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="spec-tab" data-bs-toggle="tab" data-bs-target="#spec" type="button">Specifications</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="warranty-tab" data-bs-toggle="tab" data-bs-target="#warranty" type="button">Warranty</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button">Reviews</button>
          </li>
        </ul>

        <div class="tab-content p-3 border border-top-0 bg-white" id="productTabContent">
          <!-- Specifications -->
          <div class="tab-pane fade show active" id="spec">
            {% if sub_images %}
              <div class="specifications-list mt-3">
                {% for sub_image in sub_images %}
                  <div class="d-flex align-items-center mb-3">
                    <img src="{{ url_for('static', filename=sub_image['image_url']) }}" alt="Sub-image {{ loop.index }}" style="width:100px; height:100px; object-fit:cover; margin-right:15px; border:1px solid #ddd; border-radius:5px;">
                    <p>{{ sub_image['description'] }}</p>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p>No specifications available.</p>
            {% endif %}
          </div>

          <!-- Warranty -->
          <div class="tab-pane fade" id="warranty">
            <div class="mt-3">
              <h5>Warranty & Return Policies</h5>
              <ul>
                <li>7 Days Return: Hassle-free returns within 7 days of purchase.</li>
                <li>Easy Cancellation & Refund: Refund in 7–10 business days.</li>
                <li>Secure Payment: 100% secure payments powered by Razorpay.</li>
              </ul>
            </div>
          </div>

          <!-- Reviews -->
          <div class="tab-pane fade" id="reviews">
            <div class="reviews-section mt-3">
              {% if current_user.is_authenticated %}
              <div class="review-form-section mb-4">
                <h3>{% if user_review %}Edit Your Review{% else %}Write a Review{% endif %}</h3>
                <form action="{{ url_for('product_detail', product_id=product['id']) }}" method="post">
                  <div class="mb-3">
                    <label for="rating" class="form-label">Rating</label>
                    <select class="form-select" id="rating" name="rating" required>
                      <option value="">Select a rating</option>
                      {% for i in range(5,0,-1) %}
                        <option value="{{i}}" {% if user_review and user_review['rating'] == i %}selected{% endif %}>{{i}} Stars</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="comment" class="form-label">Comment</label>
                    <textarea class="form-control" id="comment" name="comment" rows="4" required>{{ user_review['comment'] if user_review }}</textarea>
                  </div>
                  <button type="submit" class="btn btn-success">{% if user_review %}Update Review{% else %}Submit Review{% endif %}</button>
                </form>
              </div>
              {% else %}
              <p>Please <a href="{{ url_for('login') }}">log in</a> to write a review.</p>
              {% endif %}

              {% if reviews %}
                {% for review in reviews %}
                <div class="review-card">
                  <div class="review-header d-flex justify-content-between">
                    <span class="review-author">{{ review['username'] }}</span>
                    <span class="review-date">{{ review['created_at'] }}</span>
                  </div>
                  <div class="rating-stars mb-2">
                    {% for i in range(review['rating']) %}
                      <i class="bi bi-star-fill"></i>
                    {% endfor %}
                    {% for i in range(5 - review['rating']) %}
                      <i class="bi bi-star"></i>
                    {% endfor %}
                  </div>
                  <p class="review-comment">{{ review['comment'] }}</p>
                </div>
                {% endfor %}
              {% else %}
                <p>No reviews yet. Be the first to review this product!</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    {% else %}
      <p class="text-center">Product details could not be loaded.</p>
    {% endif %}
  </div>

  <!-- Add Sub-image Modal -->
  {% if current_user.is_authenticated and current_user.is_admin %}
  <div class="modal fade" id="subImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form action="{{ url_for('add_sub_image', product_id=product['id']) }}" method="post" enctype="multipart/form-data" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload Sub-image & Description</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Sub-image</label>
            <input type="file" class="form-control" name="sub_image" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="sub_description" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Upload</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
{% include 'footer.html' %}
  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function () {
    const mainImg = document.getElementById('mainImg');
    const mainBox = document.getElementById('mainImageBox');
    const zoomResult = document.getElementById('zoomResult');
    const strip = document.getElementById('thumbStrip');
    const thumbs = strip ? strip.querySelectorAll('.gs-thumb') : [];
    const prevBtn = document.getElementById('thumbPrev');
    const nextBtn = document.getElementById('thumbNext');

    function setMain(src) {
      if (!mainImg || !zoomResult) return;
      mainImg.src = src;
      zoomResult.style.backgroundImage = `url('${src}')`;
      mainImg.style.transform = "rotate(0deg)";
    }

    if (mainImg && thumbs.length) setMain(thumbs[0].getAttribute('data-src'));

    let SCALE = 2.2, bgW = 0, bgH = 0;
    function initZoom() {
      if (!mainImg || !zoomResult) return;
      const natW = mainImg.naturalWidth || mainImg.width;
      const natH = mainImg.naturalHeight || mainImg.height;
      bgW = natW * SCALE;
      bgH = natH * SCALE;
      zoomResult.style.backgroundSize = `${bgW}px ${bgH}px`;
    }
    function moveLens(e) {
      if (!mainImg || !zoomResult) return;
      const imgRect = mainImg.getBoundingClientRect();
      let x = Math.max(0, Math.min(e.clientX - imgRect.left, imgRect.width));
      let y = Math.max(0, Math.min(e.clientY - imgRect.top, imgRect.height));
      const scaleX = bgW / imgRect.width;
      const scaleY = bgH / imgRect.height;
      zoomResult.style.backgroundPosition = `${-(x*scaleX - zoomResult.clientWidth/2)}px ${-(y*scaleY - zoomResult.clientHeight/2)}px`;
    }
    if (mainImg && zoomResult && mainBox) {
      mainBox.addEventListener('mouseenter', ()=>{initZoom(); zoomResult.style.display='block';});
      mainBox.addEventListener('mousemove', moveLens);
      mainBox.addEventListener('mouseleave', ()=>{zoomResult.style.display='none';});
      window.addEventListener('resize', initZoom);
    }

    thumbs.forEach(thumb => {
      thumb.addEventListener('click', ()=>{
        thumbs.forEach(t=>t.classList.remove('active'));
        thumb.classList.add('active');
        setMain(thumb.getAttribute('data-src'));
        initZoom();
      });
    });

    function updateNavDisabled() {
      if(!strip) return;
      prevBtn.disabled = strip.scrollLeft <=0;
      nextBtn.disabled = strip.scrollLeft >= strip.scrollWidth - strip.clientWidth -1;
    }
    const SCROLL_BY = 220;
    if(prevBtn && nextBtn && strip){
      prevBtn.addEventListener('click', ()=>{strip.scrollBy({left:-SCROLL_BY, behavior:'smooth'}); setTimeout(updateNavDisabled,250);});
      nextBtn.addEventListener('click', ()=>{strip.scrollBy({left:SCROLL_BY, behavior:'smooth'}); setTimeout(updateNavDisabled,250);});
      strip.addEventListener('scroll', updateNavDisabled);
      window.addEventListener('resize', updateNavDisabled);
      updateNavDisabled();
    }
  })();
  </script>
</body>
</html>
